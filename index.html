<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mobile PDF & Image Toolbox</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<style>
html, body {
  margin:0; padding:0; width:100%; height:100%; font-family:Arial,sans-serif;
  background:#f9fafb; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; overflow-x:hidden;
}
header {
  background:linear-gradient(135deg,#4f46e5,#3b82f6); color:white;
  text-align:center; padding:1rem; width:100%; border-radius:0 0 1rem 1rem; box-sizing:border-box;
}
main {
  flex:1; width:100%; max-width:420px; padding:1rem; display:flex;
  flex-direction:column; gap:1rem; box-sizing:border-box;
}
.card {
  background:white; border-radius:1rem; padding:1rem;
  box-shadow:0 4px 12px rgba(0,0,0,0.15); display:flex; flex-direction:column; gap:0.5rem;
}
select,input,button {
  padding:0.75rem; border-radius:0.75rem; border:1px solid #d1d5db;
  font-size:1rem; width:100%; box-sizing:border-box;
}
button {
  background:linear-gradient(135deg,#3b82f6,#2563eb); color:white; border:none; font-weight:bold;
  cursor:pointer; transition:background 0.3s;
}
button:hover {
  background:linear-gradient(135deg,#2563eb,#1d4ed8);
}
.file-list { display:flex; flex-wrap:wrap; gap:0.5rem; justify-content:flex-start; }
.thumb { width:80px; height:80px; object-fit:cover; border-radius:1rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.hidden { display:none; }
progress { width:100%; height:1rem; border-radius:0.75rem; }
.btn-group { display:flex; gap:0.5rem; margin-top:0.5rem; }
</style>
</head>
<body>
<header><h1>ðŸ“„ Mobile PDF & Image Toolbox</h1></header>
<main>
<div class="card">
  <label for="operation">Choose Operation:</label>
  <select id="operation">
    <option value="images-to-pdf">Images â†’ PDF</option>
    <option value="merge-pdf">Merge PDFs</option>
    <option value="pdf-to-images">PDF â†’ Images</option>
    <option value="split-pdf">Split PDF</option>
    <option value="convert-images">Convert Images</option>
  </select>
  <input type="file" id="file-input" multiple />
  <div id="image-format-group" class="hidden">
    <label for="image-format">Output Image Format:</label>
    <select id="image-format">
      <option value="image/png">PNG</option>
      <option value="image/jpeg">JPEG</option>
      <option value="image/webp">WEBP</option>
    </select>
  </div>
  <div id="page-range-group" class="hidden">
    <label for="page-range">Page numbers (e.g. 1,3-5):</label>
    <input type="text" id="page-range" placeholder="Enter page numbers" />
  </div>
  <div class="file-list" id="file-list"></div>
  <progress id="progress" value="0" max="100" class="hidden"></progress>
  <div class="btn-group">
    <button id="run-btn">Run</button>
    <button id="clear-btn" style="background:#e5e7eb;color:#111;">Clear</button>
    <button id="download-btn" class="hidden" style="background:#10b981;color:white;">Download</button>
  </div>
  <div id="output"></div>
</div>
</main>
<script>
const operation=document.getElementById('operation');
const fileInput=document.getElementById('file-input');
const fileList=document.getElementById('file-list');
const runBtn=document.getElementById('run-btn');
const clearBtn=document.getElementById('clear-btn');
const downloadBtn=document.getElementById('download-btn');
const output=document.getElementById('output');
const imgFormatGroup=document.getElementById('image-format-group');
const pageRangeGroup=document.getElementById('page-range-group');
const progress=document.getElementById('progress');
const imageFormat=document.getElementById('image-format');
const pageRange=document.getElementById('page-range');

let selectedFiles=[];
let createdFileBlob=null;

// Allowed MIME types
const fileTypes={
  'images-to-pdf':['image/png','image/jpeg','image/jpg','image/webp'],
  'merge-pdf':['application/pdf'],
  'pdf-to-images':['application/pdf'],
  'split-pdf':['application/pdf'],
  'convert-images':['image/png','image/jpeg','image/jpg','image/webp']
};

// Show/Hide controls
operation.addEventListener('change',()=>{
  imgFormatGroup.classList.toggle('hidden',operation.value!=='convert-images');
  pageRangeGroup.classList.toggle('hidden',!(operation.value==='convert-images'||operation.value==='pdf-to-images'||operation.value==='split-pdf'));
  clearSelection();
});

// File input validation
fileInput.addEventListener('change',e=>{
  const allowed=fileTypes[operation.value];
  const files=Array.from(e.target.files);
  selectedFiles=files.filter(f=>allowed.includes(f.type));
  if(selectedFiles.length<files.length) alert('Some files ignored due to invalid type.');
  renderFileList();
});

// Clear button
clearBtn.addEventListener('click',clearSelection);
function clearSelection(){
  fileInput.value='';
  selectedFiles=[];
  fileList.innerHTML='';
  output.innerHTML='';
  progress.classList.add('hidden');
  downloadBtn.classList.add('hidden');
  createdFileBlob=null;
}

// Render files with drag-and-drop
function renderFileList(){
  fileList.innerHTML='';
  selectedFiles.forEach((file,idx)=>{
    const el=file.type.startsWith('image/')?document.createElement('img'):document.createElement('div');
    if(file.type.startsWith('image/')){el.src=URL.createObjectURL(file);el.className='thumb';}
    else {el.textContent=file.name;el.style.padding='0.5rem';el.style.border='1px solid #ddd';el.style.borderRadius='1rem';}
    el.draggable=true;
    el.dataset.index=idx;
    fileList.appendChild(el);
  });
  initDragAndDrop();
}

function initDragAndDrop(){
  let dragged;
  fileList.querySelectorAll('[draggable=true]').forEach(el=>{
    el.addEventListener('dragstart',e=>{dragged=el;});
    el.addEventListener('dragover',e=>{e.preventDefault();});
    el.addEventListener('drop',e=>{
      e.preventDefault();
      if(dragged && dragged!==el){
        const oldIndex=+dragged.dataset.index;
        const newIndex=+el.dataset.index;
        const moved=selectedFiles.splice(oldIndex,1)[0];
        selectedFiles.splice(newIndex,0,moved);
        renderFileList();
      }
    });
  });
}

// Page selection parser
function parsePageNumbers(str){
  const pages=new Set();
  if(!str) return pages;
  str.split(',').forEach(part=>{
    if(part.includes('-')){
      const [start,end]=part.split('-').map(Number);
      for(let i=start;i<=end;i++) pages.add(i-1);
    } else pages.add(Number(part)-1);
  });
  return pages;
}

// Cross-browser download
function downloadBlob(blob,filename){
  if(!blob){alert('No file ready!'); return;}
  if(window.navigator && window.navigator.msSaveOrOpenBlob) window.navigator.msSaveOrOpenBlob(blob,filename);
  else{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=filename;
    a.target='_blank';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
}

// Convert Images
async function convertImages(files,format,pages){
  for(let i=0;i<files.length;i++){
    if(!files[i].type.startsWith('image/')) continue;
    if(pages.size>0 && !pages.has(i)) continue;
    const imgFile=files[i];
    const imgURL=URL.createObjectURL(imgFile);
    const img=new Image();
    await new Promise(resolve=>{img.onload=resolve; img.src=imgURL;});
    const canvas=document.createElement('canvas');
    canvas.width=img.width; canvas.height=img.height;
    const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0);
    await new Promise(res=>canvas.toBlob(blob=>{
      createdFileBlob=blob;
      downloadBtn.classList.remove('hidden');
      res();
    },format));
  }
}

// Run button
runBtn.addEventListener('click',async()=>{
  if(selectedFiles.length===0){ alert('Please select files'); return; }
  output.innerHTML=''; progress.classList.remove('hidden'); progress.value=10;
  createdFileBlob=null; downloadBtn.classList.add('hidden');
  const pages=parsePageNumbers(pageRange.value);

  if(operation.value==='images-to-pdf'){
    const pdfDoc=await PDFLib.PDFDocument.create();
    for(const file of selectedFiles){
      const imgBytes=await file.arrayBuffer();
      const img=file.type==='image/png'?await pdfDoc.embedPng(imgBytes):await pdfDoc.embedJpg(imgBytes);
      const page=pdfDoc.addPage([1080,1920]);
      page.drawImage(img,{x:0,y:0,width:1080,height:1920});
    }
    const pdfBytes=await pdfDoc.save();
    createdFileBlob=new Blob([pdfBytes],{type:'application/pdf'});
    downloadBtn.classList.remove('hidden');
  }
  else if(operation.value==='convert-images'){
    await convertImages(selectedFiles,imageFormat.value,pages);
  }
  else if(operation.value==='merge-pdf'){
    const pdfDoc=await PDFLib.PDFDocument.create();
    for(const file of selectedFiles){
      const bytes=await file.arrayBuffer();
      const donor=await PDFLib.PDFDocument.load(bytes);
      const copiedPages=await pdfDoc.copyPages(donor,donor.getPageIndices());
      copiedPages.forEach(p=>pdfDoc.addPage(p));
    }
    const mergedBytes=await pdfDoc.save();
    createdFileBlob=new Blob([mergedBytes],{type:'application/pdf'});
    downloadBtn.classList.remove('hidden');
  }
  else if(operation.value==='pdf-to-images'){
    alert('PDFâ†’Images will be implemented later');
  }
  else if(operation.value==='split-pdf'){
    alert('Split PDF will be implemented later');
  }
  progress.value=100;
});

// Download button
downloadBtn.addEventListener('click',()=>{ 
  if(createdFileBlob){
    const ext=(operation.value==='images-to-pdf'||operation.value==='merge-pdf')?'pdf':'file';
    downloadBlob(createdFileBlob,'output.'+ext);
  }
});
</script>
</body>
</html>
